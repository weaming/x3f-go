name: Release

on:
  push:
    tags:
      - 'release-*'

permissions:
  contents: write

jobs:
  # macOS Universal Binary (arm64 + amd64)
  build-macos:
    name: Build macOS Universal Binary
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Fish shell
        run: brew install fish

      - name: Cache OpenCV build
        id: cache-opencv
        uses: actions/cache@v3
        with:
          path: build/opencv-install
          key: opencv-macos-${{ hashFiles('build-opencv-static.fish') }}

      - name: Build OpenCV static library
        if: steps.cache-opencv.outputs.cache-hit != 'true'
        run: fish build-opencv-static.fish

      - name: Build x3f-go Universal Binary
        run: fish build-all.fish

      - name: Verify build
        run: |
          lipo -info build/release/x3f-go-darwin-universal
          ./build/release/x3f-go-darwin-universal --help

      - name: Package release
        run: |
          cd build/release
          tar -czf x3f-go-darwin-universal.tar.gz x3f-go-darwin-universal
          shasum -a 256 x3f-go-darwin-universal.tar.gz > x3f-go-darwin-universal.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: x3f-go-darwin-universal
          path: |
            build/release/x3f-go-darwin-universal.tar.gz
            build/release/x3f-go-darwin-universal.tar.gz.sha256

  # Linux amd64
  build-linux:
    name: Build Linux (amd64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake git pkg-config \
            fish

      - name: Cache OpenCV build
        id: cache-opencv
        uses: actions/cache@v3
        with:
          path: build/opencv-install
          key: opencv-linux-${{ hashFiles('build-opencv-static.fish') }}

      - name: Build OpenCV static library
        if: steps.cache-opencv.outputs.cache-hit != 'true'
        run: fish build-opencv-static.fish

      - name: Build x3f-go
        run: fish build-all.fish

      - name: Verify build
        run: |
          file build/release/x3f-go-linux-amd64
          ./build/release/x3f-go-linux-amd64 --help

      - name: Package release
        run: |
          cd build/release
          tar -czf x3f-go-linux-amd64.tar.gz x3f-go-linux-amd64
          sha256sum x3f-go-linux-amd64.tar.gz > x3f-go-linux-amd64.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: x3f-go-linux-amd64
          path: |
            build/release/x3f-go-linux-amd64.tar.gz
            build/release/x3f-go-linux-amd64.tar.gz.sha256

  # Windows amd64
  build-windows:
    name: Build Windows (amd64)
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            mingw-w64-x86_64-pkg-config
            git
            fish

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Cache OpenCV build
        id: cache-opencv
        uses: actions/cache@v3
        with:
          path: build/opencv-install
          key: opencv-windows-${{ hashFiles('build-opencv-static.fish') }}

      - name: Build OpenCV static library
        if: steps.cache-opencv.outputs.cache-hit != 'true'
        run: fish build-opencv-static.fish

      - name: Build x3f-go
        run: fish build-all.fish

      - name: Verify build
        run: |
          file build/release/x3f-go-windows-amd64.exe
          ./build/release/x3f-go-windows-amd64.exe --help

      - name: Package release
        run: |
          cd build/release
          zip x3f-go-windows-amd64.zip x3f-go-windows-amd64.exe
          sha256sum x3f-go-windows-amd64.zip > x3f-go-windows-amd64.zip.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: x3f-go-windows-amd64
          path: |
            build/release/x3f-go-windows-amd64.zip
            build/release/x3f-go-windows-amd64.zip.sha256

  # Create GitHub Release
  release:
    name: Create GitHub Release
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/x3f-go-darwin-universal/*.tar.gz
            artifacts/x3f-go-darwin-universal/*.sha256
            artifacts/x3f-go-linux-amd64/*.tar.gz
            artifacts/x3f-go-linux-amd64/*.sha256
            artifacts/x3f-go-windows-amd64/*.zip
            artifacts/x3f-go-windows-amd64/*.sha256
          body: |
            ## x3f-go 自动发布

            ### 下载

            | 平台 | 架构 | 下载 |
            |------|------|------|
            | macOS | Universal (arm64 + amd64) | `x3f-go-darwin-universal.tar.gz` |
            | Linux | amd64 | `x3f-go-linux-amd64.tar.gz` |
            | Windows | amd64 | `x3f-go-windows-amd64.zip` |

            ### 安装

            **macOS/Linux:**
            ```bash
            tar -xzf x3f-go-*.tar.gz
            chmod +x x3f-go-*
            ./x3f-go-* --help
            ```

            **Windows:**
            ```powershell
            # 解压 zip 文件后直接运行
            x3f-go-windows-amd64.exe --help
            ```

            ### 特性

            - ✅ 完整的 X3F RAW 格式支持
            - ✅ OpenCV 加速处理（降噪、插值、坏点修复）
            - ✅ 支持 Quattro 传感器
            - ✅ 多种输出格式（DNG, TIFF, JPEG, HEIF）
            - ✅ 静态编译，无需依赖

            ### 校验

            使用 SHA256 校验文件完整性：
            ```bash
            # macOS/Linux
            shasum -c x3f-go-*.sha256

            # Windows
            CertUtil -hashfile x3f-go-windows-amd64.zip SHA256
            ```
